
@{
    ViewBag.Title = "DashBord";
    Layout = "~/Views/Shared/CellEngineerLayout.cshtml";
    if (Session["userID"] == null)
    {
        Response.Redirect("~/Login/Index");
    }
    int lineid = ViewBag.lineId;
    using (issue_management_systemEntities1 db = new issue_management_systemEntities1())
    {
        var lineInfo = db.lines.Where(x => x.line_id == lineid).FirstOrDefault();
        ViewBag.LineName = lineInfo.line_name;

    }
}



@using IssueManagementSystem.Models;
@model List<IssueManagementSystem.Models.issue_occurrence>
<div class="page-content--bgf7">
    <section class="au-breadcrumb2">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <div class="au-breadcrumb-content">
                        <div class="au-breadcrumb-left">
                            <span class="au-breadcrumb-span">You are here:</span>
                            <ul class="list-unstyled list-inline au-breadcrumb__list">
                                <li class="list-inline-item active">
                                    <a href="#">CellEngineer</a>
                                </li>
                                <li class="list-inline-item seprate">
                                    <span>/</span>
                                </li>
                                <li class="list-inline-item">Dashboard</li>
                                <li class="list-inline-item seprate">
                                    <span>/</span>
                                </li>
                                <li class="list-inline-item active">
                                    <a href="#">@ViewBag.LineName</a>
                                </li>
                            </ul>
                        </div>

                        <button onclick="startConverting();"> Allow Your Voice <i class="fa fa-microphone"></i></button>

                    </div>
                </div>
            </div>
        </div>
    </section>
    <section class="welcome p-t-10">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <h1 class="title-4">
                        Welcome back @Session["name"]
                    </h1>
                    <hr class="line-seprate">
                </div>
            </div>
        </div>
    </section>
    <section class="welcome p-t-10" style="padding-top:50px;padding-bottom:50px">
        <div class="container-fluid">
            <div class="row" id="divIssue" style="margin: auto;">


            </div>

        </div>
    </section>

</div>
<style>
    #result {
        height: 200px;
        border: 1px solid #ccc;
        padding: 10px;
        box-shadow: 0 0 10px 0 #bbb;
        margin-bottom: 30px;
        font-size: 14px;
        line-height: 25px;
    }
</style>

<script src="~/Scripts/jquery-3.3.1.js"></script>

<script src="~/Scripts/angular.min.js"></script>
<script src="~/Scripts/jquery.signalR-2.3.0.min.js"></script>
<script src="~/signalr/Hubs"></script>
<div id="result" hidden></div>

<script type="text/javascript">
var r = document.getElementById('result');
   $(function(){
  if ('speechSynthesis' in window) {
    speechSynthesis.onvoiceschanged = function() {}
     $('#speak').click(function(){
      var msg = new SpeechSynthesisUtterance();
      var voices = window.speechSynthesis.getVoices();
      msg.voice = voices[1];
      msg.rate = 1;
      msg.pitch = 1;
      msg.text = "Hello";
      msg.onend = function(e) {
      console.log('Finished in ' + event.elapsedTime + ' seconds.');
    };
      speechSynthesis.speak(msg);
     })
    }
  });

    startConverting ()
	function startConverting ()
    {

		if('webkitSpeechRecognition' in window){
			var speechRecognizer = new webkitSpeechRecognition();
			speechRecognizer.continuous = true;
			speechRecognizer.interimResults = true;
			speechRecognizer.lang = 'en-IN';
			speechRecognizer.start();

			var finalTranscripts = '';

			speechRecognizer.onresult = function(event){
				var interimTranscripts = '';
				for(var i = event.resultIndex; i < event.results.length; i++){
					var transcript = event.results[i][0].transcript;

					if(event.results[i].isFinal){
						finalTranscripts += transcript;
					}else{
						interimTranscripts += transcript;
					}
				}
				r.innerHTML =  interimTranscripts
                    VoiceAction( interimTranscripts )
			};
			speechRecognizer.onerror = function (event) {
			};
		}else{
			r.innerHTML = 'Your browser is not supported. If google chrome, please upgrade!';
		}
	}

		function playVoice(){
			var msg = new SpeechSynthesisUtterance('Hello World');
			window.speechSynthesis.speak(msg);

			speechSynthesis.speak(new SpeechSynthesisUtterance('Hello World'));
		}
        function VoiceAction(keyWord )
        {
            if(keyWord=="breakdown" || keyWord==" breakdown")
            {
                debugger;
                window.location.href = '/CellEngineer/MachinBreakdown?lineid=' +  @ViewBag.lineId;
            }
            if(keyWord=="technical" || keyWord==" technical")
            {
                window.location.href = '/CellEngineer/TechnicalIssue?lineid=' +  @ViewBag.lineId;
            }
            if(keyWord=="material" || keyWord==" material")
            {
                window.location.href = '/CellEngineer/MaterialDelay?lineid=' +  @ViewBag.lineId;
            }
        if(keyWord=="it" || keyWord==" it")
            {
                window.location.href = '/CellEngineer/ITIssue?lineid=' +  @ViewBag.lineId;
            }
        if(keyWord=="show me today's summary" || keyWord==" show me today's summary")
            {
                var url = '@Url.Action("GetIssues", "Supervisor")';
                $.ajax({
                url: url,
                    type: 'GET',
                    datatype: 'json',
                    success: function (issuedata) { alert(issuedata) },
                    error: function () {alert("Error!")}
                });
            }
            else
         //   speek("I don't no that word");

        }

</script>


<script>
    $(document).ready(function () {

        // Proxy created on the fly
        var hub = $.connection.issueHub;
        var issueCount = 0;

        // Declare a function on the hub hub so the server can invoke it
        hub.client.displayStatus = function () {
            debugger
            getData();
        };

        // Start the connection
        $.connection.hub.start();
        getData();

        function getData()
        {

            var divissue = $('#divIssue');
             var url = '@Url.Action("GetIssues", "Supervisor")';
            $.ajax({
                url: url,
                    type: 'GET',
                    datatype: 'json',
                    success: function (issuedata) {

                    issuedata = $.parseJSON(issuedata);
                    if (issuedata.length > 0) {
                        divissue.empty();

                        for (var i = 0; i < issuedata.length; i++) {

                            if ((issuedata[i].line_line_id==@ViewBag.lineId ) && (issuedata[i].issue_satus=="1" )) {
                                var responcibleperson_ststus= issuedata[i].responsible_person_confirm_status
                                var issueid = issuedata[i].issue_issue_ID
                                var responce_comment = issuedata[i].responsible_person_confirm_feedback
                                var date = issuedata[i].issueDate.split(' ');
                                var day = moment(date[0], 'M/D/Y/').format('MMMM D Y');
                                var issue_occurrence_id = issuedata[i].issue_occurrence_id
                                var issue
                                if (issueid == 1)//breakedown
                                {

                                    issue = '<div class="col-md-6 col-lg-4" style=" margin-top: 10px;"><div class="card"> <div class="statistic__item statistic__item--red"><span class="desc" style="color:white">Machine Breakdown</span><div class="icon" ><i class="zmdi zmdi-settings zmdi-hc-spin"></i></div></div><div class="card-body"><h5 class="card-title" ></h5><div style="display:none" id="check' + issue_occurrence_id+'"><i  class="fas fa-check" style="font-size:30px; color:green;float:right;"></i></div><p class="card-text"><strong>Issue Date : </strong>' + day + '</br><strong>Time : </strong> ' + date[1] + " " + date[2] + '</br><strong>Responsible Person :</strong> ' + issuedata[i].responciblepersonName + '</br><strong>Machine : </strong>' + issuedata[i].machine_machine_id + '</p> <div class="text-right"> <button  class="btn btn-success"   data-id="' + issue_occurrence_id + '"  data-issue_id="' + issueid + '" onclick="myfunction(this)">Solved </button></div></div><div class="card-footer"><small class="text-muted">Last updated 3 mins ago</small></div></div><div>'

                                }
                                if (issueid == 2)//Material Delay
                                {

                                    issue = '<div class="col-md-6 col-lg-4" style=" margin-top: 10px;"><div class="card"> <div class="statistic__item statistic__item--orange"><span class="desc" style="color:white">Material Delay</span><div class="icon" ><i class="zmdi animated infinite wobble zmdi-shopping-cart"></i></div></div><div class="card-body"><h5 class="card-title" ></h5><div style="display:none" id="check' + issue_occurrence_id +'"><i  class="fas fa-check" style="font-size:30px; color:green;float:right;"></i></div><p class="card-text"><strong>Issue Date : </strong>' + day + '</br><strong>Time : </strong> ' + date[1] + " " + date[2] + '</br><strong>Responsible Person :</strong> ' + issuedata[i].responciblepersonName + '</br><strong>Matirial : </strong>' + issuedata[i].matirial+'</p> <div class="text-right"><button  class="btn btn-success"  data-id="' + issue_occurrence_id + '" data-issue_id="' + issueid +'" onclick="myfunction(this)">Solved</button></div></div><div class="card-footer"><small class="text-muted">Last updated 3 mins ago</small></div></div><div>'


                                }
                                if (issueid == 3)//Technical Issue
                                {


                                    issue = '<div class="col-md-6 col-lg-4" style=" margin-top: 10px;"><div class="card"> <div class="statistic__item statistic__item--green"><span class="desc" style="color:white">Technical Issue</span><div class="icon" ><i class="fas fa-wrench"></i></div></div><div class="card-body"><h5 class="card-title" ></h5><div style="display:none" id="check' + issue_occurrence_id +'"><i  class="fas fa-check" style="font-size:30px; color:green;float:right;"></i></div><p class="card-text"><strong>Issue Date : </strong>' + day + '</br><strong>Time : </strong>' + date[1] + " " + date[2] + '</br><strong>Responsible Person :</strong> ' + issuedata[i].responciblepersonName + '</p> <div class="text-right"> <button  class="btn btn-success"  data-id="' + issue_occurrence_id + '" data-issue_id="' + issueid +'" onclick="myfunction(this)">Solved</button></div></div><div class="card-footer"><small class="text-muted">Last updated 3 mins ago</small></div></div><div>'
                                }
                                if (issueid == 4)//Quility
                                {
                                    issue = '<div class="col-md-6 col-lg-4" style=" margin-top: 10px;"><div class="card"> <div class="statistic__item statistic__item--blue"><span class="desc" style="color:white">Qulity Issue</span><div class="icon" ><i class="zmdi zmdi-brightness-auto"></i></div></div><div class="card-body"><h5 class="card-title" ></h5><div style="display:none" id="check' + issue_occurrence_id +'"><i  class="fas fa-check" style="font-size:30px; color:green;float:right;"></i></div><p class="card-text"><strong>IssueDate : </strong>' + day + '</br><strong>Time : </strong>' + date[1] + " " + date[2] + '</br><strong>Responsible Person :</strong> ' + issuedata[i].responciblepersonName + '</p><div class="text-right"> <button  class="btn btn-success"  data-id="' + issue_occurrence_id + '" data-issue_id="' + issueid +'" onclick="myfunction(this)">Solved</button></div></div><div class="card-footer"><small class="text-muted">Last updated 3 mins ago</small></div></div><div>'
                                }
                                if (issueid == 5)//IT/Software
                                {

                                    issue = '<div class="col-md-6 col-lg-4" style=" margin-top: 10px;"><div class="card"> <div class="statistic__item statistic__item--blue"><span class="desc" style="color:white">IT/Software Issue</span><div class="icon" ><i class="zmdi zmdi-windows"></i></div></div><div class="card-body"><h5 class="card-title" ></h5><div style="display:none" id="check' + issue_occurrence_id +'"><i  class="fas fa-check" style="font-size:30px; color:green;float:right;"></i></div><p class="card-text"><strong>Issue Date : </strong>' + day + '</br><strong>Time : </strong>' + date[1] + " " + date[2] + '</br><strong>Responsible Person :</strong> ' + issuedata[i].responciblepersonName + '</p> <div class="text-right"> <button  class="btn btn-success"  data-id="' + issue_occurrence_id + '" data-issue_id="' + issueid +'"onclick="myfunction(this)">Solved</button></div></div><div class="card-footer"><small class="text-muted">Last updated 3 mins ago</small></div></div><div>'

                                }

                                divissue.append(issue)
                                divissue.show('slow');
                                if (responce_comment != '') {
                                    document.getElementById("check" + issue_occurrence_id).style.display = "block" }

                            }



                        }


                    }
                }, error: function (r, e, w) {
                }
            });
        }

    })

        function myfunction(param) {
            var id = $(param).data('id');
            var issue_id = $(param).data('issue_id');
            var url = '@Url.Action("SolvedIssue", "Supervisor")?issueId=' + issue_id + '&issueOccourId=' + id+'&lineId='+'@ViewBag.lineId ';

            $.ajax({
                url: url,
                type: 'POST',

                success: function (issuedata) {
                     $.connection.hub.start()
                    .done(function () {
                        console.log("Worked")
                        $.connection.ismHub.server.announce();
                    })
                    .fail(function () { alert("ERROR!") });
                        }
            });

        }



</script>

<!-- <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/materialize/0.95.1/css/materialize.min.css"> -->

<div class="container">



    <div class="row">
        <div class="input-field col s12">
            <textarea id="message" class="materialize-textarea"></textarea>

        </div>
    </div>
    <a href="#" id="speak" class="waves-effect waves-light btn" hidden>Speak</a>

</div>

<div id="modal1" class="modal">
    <h4>Speech Synthesis not supported</h4>
    <p>Your browser does not support speech synthesis.</p>
    <p>We recommend you use Google Chrome.</p>
    <div class="action-bar">
        <a href="#" class="waves-effect waves-green btn-flat modal-action modal-close">Close</a>
    </div>
</div>


<!--<script src="//cdnjs.cloudflare.com/ajax/libs/materialize/0.95.1/js/materialize.min.js"></script> -->